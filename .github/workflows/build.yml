name: Deploy Temporary site

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nginx
        run: |
          sudo apt update
          sudo apt install -y nginx
          sudo systemctl start nginx
          sudo service nginx status
          
      # --- （可选）配置 Nginx 服务你的网站内容 ---
      # 如果你的 HTML/CSS/JS 文件在仓库的 'public' 目录下
      # - name: Copy website files to Nginx root
      #   run: sudo cp -r ./public/* /var/www/html/
      #
      # 或者，如果你有自定义的 Nginx 配置文件在仓库的 'nginx.conf'
      # - name: Setup custom Nginx configuration
      #   run: |
      #     sudo cp ./nginx.conf /etc/nginx/sites-available/default
      #     sudo nginx -t # 测试配置是否有效
      #     sudo systemctl reload nginx # 重新加载 Nginx 配置


      - name: Setup SSHD
        env:
          SSH_PUBLIC_KEY_SECRET: ${{ secrets.SSHD_AUTHORIZED_KEYS }}
        run: |
          EXPECTED_PUBKEY_VAR="SSH_PUBLIC_KEY_SECRET"
          TARGET_SSH_CONFIG="/etc/ssh/sshd_config"

          TARGET_USER_HOME="~"
          eval TARGET_USER_HOME="$TARGET_USER_HOME"
          TARGET_AUTH_KEYS_FILE="${TARGET_USER_HOME}/.ssh/authorized_keys"
          
          if [ -z "${!EXPECTED_PUBKEY_VAR}" ]; then
            echo "::error:: Environment variable ${EXPECTED_PUBKEY_VAR} is not set or empty."
            echo "Please set it with your SSH public key content before running this script."
            exit 1
          fi
          SSH_PUBLIC_KEY="${!EXPECTED_PUBKEY_VAR}"

          echo "Installing OpenSSH Server..."
          sudo apt install -y openssh-server
          
          echo "Configuring ${TARGET_SSH_CONFIG}..."
          
          # 备份原始配置文件
          sudo cp "${TARGET_SSH_CONFIG}" "${TARGET_SSH_CONFIG}.bak_$(date +%F_%T)"
          
          # 启用公钥认证
          # 使用 sed 修改配置。-i 表示直接修改文件。
          # s/^[#[:space:]]*PubkeyAuthentication.*/PubkeyAuthentication yes/ :
          #   ^             - 行首
          #   [#[:space:]]* - 匹配可选的 '#' 或空格（处理注释掉或未注释的行）
          #   PubkeyAuthentication - 匹配指令
          #   .*            - 匹配该行的剩余部分
          #   PubkeyAuthentication yes - 替换为的内容
          echo "Ensuring PubkeyAuthentication is enabled..."
          sudo sed -i 's/^[#[:space:]]*PubkeyAuthentication.*/PubkeyAuthentication yes/' "${TARGET_SSH_CONFIG}"
          # 如果上面 sed 没有找到匹配项 (可能文件中完全没有这一行)，则追加它
          if ! grep -q "^PubkeyAuthentication yes" "${TARGET_SSH_CONFIG}"; then
              sudo echo "PubkeyAuthentication yes" >> "${TARGET_SSH_CONFIG}"
          fi
          
          
          # 禁用密码认证
          echo "Disabling PasswordAuthentication..."
          sudo sed -i 's/^[#[:space:]]*PasswordAuthentication.*/PasswordAuthentication no/' "${TARGET_SSH_CONFIG}"
          # 如果上面 sed 没有找到匹配项，则追加它
          if ! grep -q "^PasswordAuthentication no" "${TARGET_SSH_CONFIG}"; then
              sudo echo "PasswordAuthentication no" >> "${TARGET_SSH_CONFIG}"
          fi
          
          # 禁用挑战-响应认证 (这通常也涵盖了 PAM 等基于密码的交互式登录)
          echo "Disabling ChallengeResponseAuthentication..."
          sudo sed -i 's/^[#[:space:]]*ChallengeResponseAuthentication.*/ChallengeResponseAuthentication no/' "${TARGET_SSH_CONFIG}"
          # 如果上面 sed 没有找到匹配项，则追加它
          if ! grep -q "^ChallengeResponseAuthentication no" "${TARGET_SSH_CONFIG}"; then
              sudo echo "ChallengeResponseAuthentication no" >> "${TARGET_SSH_CONFIG}"
          fi
          
          # --- 重启 SSH 服务 ---
          echo "Restarting SSH service..."
          sudo systemctl restart sshd

          echo "Adding public key to ${TARGET_AUTH_KEYS_FILE}..."
          mkdir -p "${TARGET_USER_HOME}/.ssh"
          chmod 700 "${TARGET_USER_HOME}/.ssh"
          echo "${SSH_PUBLIC_KEY}" >> "${TARGET_AUTH_KEYS_FILE}"
          chmod 600 "${TARGET_AUTH_KEYS_FILE}"
          
          echo "SSHD installation and configuration complete."
          echo "Target user home: ${TARGET_USER_HOME}"
          echo "Authorized keys file: ${TARGET_AUTH_KEYS_FILE}"
      
      - name: Setup Xray
        env:
          XRAY_UUID_SECRET: ${{ secrets.XRAY_UUID }}
          XRAY_WS_PATH_SECRET: ${{ secrets.XRAY_WS_PATH }}
        run: |
          if [ -z "$XRAY_UUID_SECRET" ]; then
            echo "::error:: XRAY_UUID secret is not set. Please configure it in your repository settings."
            exit 1
          fi
          if [ -z "$XRAY_WS_PATH_SECRET" ]; then
            echo "::error:: XRAY_WS_PATH is not set. Please configure it (e.g., in repository settings or environment)."
            exit 1
          fi
          mkdir xray
          cd xray

          echo "Downloading latest Xray-core for Linux (64-bit)..."
          wget --progress=bar:force:noscroll -O xray-linux-64.zip https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip
          if [ $? -ne 0 ]; then
            echo "::error:: Failed to download Xray-core."
            exit 1
          fi

          echo "Unzipping Xray-core..."
          unzip xray-linux-64.zip
          # Since there are no subdirectories, files (xray, geoip.dat, geosite.dat) are extracted here
          if [ $? -ne 0 ]; then
            echo "::error:: Failed to unzip Xray-core."
            exit 1
          fi
          rm xray-linux-64.zip # Clean up

          echo "Generating config.json..."
          if ! command -v jq &> /dev/null; then
             echo "jq could not be found, installing..."
             sudo apt-get update && sudo apt-get install -y jq
          fi

          # Define the config template using a heredoc and pipe it to jq
          jq --arg uuid "$XRAY_UUID_SECRET" \
          --arg ws_path "$XRAY_WS_PATH_SECRET" \
          '.inbounds[0].settings.clients[0].id = $uuid | .inbounds[0].streamSettings.wsSettings.path = $ws_path' <<'EOF' > config.json
          {
            "log": { "loglevel": "info" },
            "inbounds": [
              {
                "port": 8080,
                "protocol": "vless",
                "allocate": { "strategy": "always" },
                "settings": {
                  "decryption":"none",
                  "clients": [{ "id": "", "level": 1, "alterId": 0 }]
                },
                "streamSettings": {
                  "network": "ws",
                  "wsSettings": {
                    "connectionReuse": true,
                    "path": "/"
                  },
                  "security": "none",
                  "tcpSettings": {
                    "header": {
                      "type": "http",
                      "response": {
                        "version": "1.1",
                        "status": "200",
                        "reason": "OK",
                        "headers": {
                          "Content-Type": [
                            "application/octet-stream",
                            "application/x-msdownload",
                            "text/html",
                            "application/x-shockwave-flash"
                          ],
                          "Transfer-Encoding": ["chunked"],
                          "Connection": ["keep-alive"],
                          "Pragma": "no-cache"
                        }
                      }
                    }
                  }
                }
              }
            ],
            "outbounds": [{ "protocol": "freedom", "settings": {} }]
          }
          EOF

          if [ ! -f config.json ]; then
             echo "::error:: Failed to generate config.json"
             exit 1
          fi
          echo "config.json generated successfully."

          
          echo "Starting Xray..."
          chmod +x xray
          # Add nohup to prevent SIGHUP and redirect output to files
          nohup ./xray run -config config.json &
          cd ..

      - name: ZeroTier
        uses: zerotier/github-action@v1.0.1
        with:
          network_id: ${{ secrets.ZEROTIER_NETWORK_ID }}
          auth_token: ${{ secrets.ZEROTIER_CENTRAL_TOKEN }}

      - name: Run Cloudflare Tunnel
        env:
          TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
        run: |
          wget --progress=bar:force:noscroll https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cloudflared-linux-amd64
          ./cloudflared-linux-amd64 tunnel --no-autoupdate run --token $TUNNEL_TOKEN > /dev/null
