name: Deploy Temporary site

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nginx
        run: |
          sudo apt update
          sudo apt install -y nginx
          sudo systemctl start nginx
          sudo service nginx status
          
      - name: ZeroTier
        uses: zerotier/github-action@v1.0.1
        with:
          network_id: ${{ secrets.ZEROTIER_NETWORK_ID }}
          auth_token: ${{ secrets.ZEROTIER_CENTRAL_TOKEN }}
          
      # --- （可选）配置 Nginx 服务你的网站内容 ---
      # 如果你的 HTML/CSS/JS 文件在仓库的 'public' 目录下
      # - name: Copy website files to Nginx root
      #   run: sudo cp -r ./public/* /var/www/html/
      #
      # 或者，如果你有自定义的 Nginx 配置文件在仓库的 'nginx.conf'
      # - name: Setup custom Nginx configuration
      #   run: |
      #     sudo cp ./nginx.conf /etc/nginx/sites-available/default
      #     sudo nginx -t # 测试配置是否有效
      #     sudo systemctl reload nginx # 重新加载 Nginx 配置
      - name: Setup Xray
        env:
          XRAY_UUID_SECRET: ${{ secrets.XRAY_UUID }}
        run: |
          if [ -z "$XRAY_UUID_SECRET" ]; then
            echo "::error:: XRAY_UUID secret is not set. Please configure it in your repository settings."
            exit 1
          fi
          mkdir xray
          cd xray

          echo "Downloading latest Xray-core for Linux (64-bit)..."
          wget -O xray-linux-64.zip https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip
          if [ $? -ne 0 ]; then
            echo "::error:: Failed to download Xray-core."
            exit 1
          fi

          echo "Unzipping Xray-core..."
          unzip xray-linux-64.zip
          # Since there are no subdirectories, files (xray, geoip.dat, geosite.dat) are extracted here
          if [ $? -ne 0 ]; then
            echo "::error:: Failed to unzip Xray-core."
            exit 1
          fi
          rm xray-linux-64.zip # Clean up

          echo "Generating config.json..."
          if ! command -v jq &> /dev/null; then
             echo "jq could not be found, installing..."
             sudo apt-get update && sudo apt-get install -y jq
          fi

          # Define the config template using a heredoc and pipe it to jq
          jq --arg uuid "$XRAY_UUID_SECRET" '.inbounds[0].settings.clients[0].id = $uuid' <<'EOF' > config.json
          {
            "log": { "loglevel": "info" },
            "inbounds": [
              {
                "port": 8080,
                "protocol": "vless",
                "allocate": { "strategy": "always" },
                "settings": {
                  "decryption":"none",
                  "clients": [{ "id": "", "level": 1, "alterId": 0 }]
                },
                "streamSettings": {
                  "network": "ws",
                  "wsSettings": {
                    "connectionReuse": true,
                    "path": "/message"
                  },
                  "security": "none",
                  "tcpSettings": {
                    "header": {
                      "type": "http",
                      "response": {
                        "version": "1.1",
                        "status": "200",
                        "reason": "OK",
                        "headers": {
                          "Content-Type": [
                            "application/octet-stream",
                            "application/x-msdownload",
                            "text/html",
                            "application/x-shockwave-flash"
                          ],
                          "Transfer-Encoding": ["chunked"],
                          "Connection": ["keep-alive"],
                          "Pragma": "no-cache"
                        }
                      }
                    }
                  }
                }
              }
            ],
            "outbounds": [{ "protocol": "freedom", "settings": {} }]
          }
          EOF

          if [ ! -f config.json ]; then
             echo "::error:: Failed to generate config.json"
             exit 1
          fi
          echo "config.json generated successfully."

          
          echo "Starting Xray..."
          chmod +x xray
          # Add nohup to prevent SIGHUP and redirect output to files
          nohup ./xray run -config config.json &
          cd ..

      - name: Run Cloudflare Tunnel
        env:
          TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
        run: |
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cloudflared-linux-amd64
          ./cloudflared-linux-amd64 tunnel --no-autoupdate run --token $TUNNEL_TOKEN
